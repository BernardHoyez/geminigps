<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trace GPS PWA</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png"> {/* Ajout pour iOS */}
    <meta name="theme-color" content="#3f51b5"/> {/* Correspondance avec manifest */}
    <style>
        body, html { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; }
        #map { width: 100%; height: 70vh; border-bottom: 1px solid #ccc; }
        .controls { padding: 10px; text-align: center; background-color: #f8f9fa; }
        button, select {
            padding: 10px 15px;
            margin: 5px;
            font-size: 0.9em; /* Légère réduction pour affichage mobile */
            cursor: pointer;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #fff;
        }
        button:hover { background-color: #e9e9e9; }
        button:disabled {
            background-color: #eee;
            color: #aaa;
            cursor: not-allowed;
        }
        select { padding-right: 30px; } /* Espace pour la flèche du select */
        #status { margin-top: 10px; font-style: italic; color: #555; font-size: 0.9em; }
        .loader { /* Petit indicateur de chargement pour la localisation */
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 2s linear infinite; /* Safari */
            animation: spin 2s linear infinite;
            display: none; /* Caché par défaut */
            margin: 5px auto;
        }
        @-webkit-keyframes spin {
          0% { -webkit-transform: rotate(0deg); }
          100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="controls">
        <div>
            <label for="map-source">Carte:</label>
            <select id="map-source">
                <option value="osm">OpenStreetMap</option>
                <option value="ign-plan">IGN Plan V2</option>
                <option value="ign-ortho">IGN OrthoPhotos</option>
            </select>
        </div>
        <div>
            <button id="startStopBtn">Démarrer Enregistrement</button>
            <button id="downloadGpxBtn" disabled>Télécharger GPX</button>
            <button id="downloadKmlBtn" disabled>Télécharger KML</button>
        </div>
        <div id="status">En attente de localisation...</div>
        <div class="loader" id="loader"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script>
        // --- PWA Service Worker ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => console.log('ServiceWorker: Enregistrement réussi, scope:', registration.scope))
                    .catch(err => console.log('ServiceWorker: Echec enregistrement:', err));
            });
        }

        // --- Variables Globales ---
        let map;
        let userMarker;
        let accuracyCircle;
        let trackPolyline;
        let trackPoints = [];
        let isRecording = false;
        let watchId;
        const mapSourceSelect = document.getElementById('map-source');
        const startStopBtn = document.getElementById('startStopBtn');
        const downloadGpxBtn = document.getElementById('downloadGpxBtn');
        const downloadKmlBtn = document.getElementById('downloadKmlBtn');
        const statusDiv = document.getElementById('status');
        const loader = document.getElementById('loader');

        // --- Couches de carte ---
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        });

        // IMPORTANT: Pour IGN, une clé API peut être nécessaire.
        // Consultez https://geoservices.ign.fr/documentation/services/api-et-services-ogc/donnees-raster-wms-wmts
        const ignPlanLayer = L.tileLayer('https://wxs.ign.fr/essentiels/geoportail/wmts?' + // Utilisez votre clé si vous en avez une à la place de "essentiels"
            '&REQUEST=GetTile&SERVICE=WMTS&VERSION=1.0.0' +
            '&STYLE=normal' +
            '&TILEMATRIXSET=PM' + // Pour la métropole
            '&FORMAT=image/jpeg' +
            '&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2' +
            '&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}', {
            attribution: '&copy; <a href="https://www.ign.fr/">IGN</a>',
            tileSize: 256,
            minZoom: 0,
            maxZoom: 18 // Vérifiez le maxZoom de la couche spécifique
        });

        const ignOrthoLayer = L.tileLayer('https://wxs.ign.fr/essentiels/geoportail/wmts?' +
            '&REQUEST=GetTile&SERVICE=WMTS&VERSION=1.0.0' +
            '&STYLE=normal' +
            '&TILEMATRIXSET=PM' +
            '&FORMAT=image/jpeg' +
            '&LAYER=ORTHOIMAGERY.ORTHOPHOTOS' + // Ou ORTHOIMAGERY.ORTHOPHOTOS.ORTHOIR.ORTHO
            '&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}', {
            attribution: '&copy; <a href="https://www.ign.fr/">IGN</a>',
            tileSize: 256,
            minZoom: 0,
            maxZoom: 19
        });

        // --- Initialisation de la carte ---
        function initMap(initialLayer) {
            map = L.map('map', {
                center: [43.5, 5.5], // Coordonnées initiales (Provence par exemple)
                zoom: 13,
                layers: [initialLayer] // Ajoute la couche initiale directement
            });

            map.on('locationfound', onLocationFound);
            map.on('locationerror', onLocationError);

            statusDiv.textContent = "Localisation en cours...";
            loader.style.display = 'block';
            map.locate({setView: true, maxZoom: 16, watch: false, enableHighAccuracy: true});
        }

        // --- Gestionnaire de source de carte ---
        mapSourceSelect.addEventListener('change', function() {
            map.eachLayer(layer => {
                if (layer instanceof L.TileLayer) {
                    map.removeLayer(layer);
                }
            });
            switch (this.value) {
                case 'ign-plan':
                    ignPlanLayer.addTo(map);
                    break;
                case 'ign-ortho':
                    ignOrthoLayer.addTo(map);
                    break;
                case 'osm':
                default:
                    osmLayer.addTo(map);
                    break;
            }
        });

        // --- Fonctions de Géolocalisation ---
        function onLocationFound(e) {
            const radius = e.accuracy; // accuracy est déjà en mètres
            const latlng = e.latlng;
            loader.style.display = 'none';

            if (!userMarker) {
                userMarker = L.marker(latlng).addTo(map);
                accuracyCircle = L.circle(latlng, radius, {
                    color: 'blue',
                    fillColor: '#3af',
                    fillOpacity: 0.15,
                    weight: 2
                }).addTo(map);
            } else {
                userMarker.setLatLng(latlng);
                accuracyCircle.setLatLng(latlng).setRadius(radius);
            }
            userMarker.bindPopup(`Position actuelle<br>Précision: ${radius.toFixed(0)} m`).openPopup();

            if (isRecording) {
                const now = new Date();
                trackPoints.push({
                    lat: latlng.lat,
                    lon: latlng.lng,
                    ele: e.altitude !== null ? e.altitude : 0,
                    time: now.toISOString()
                });
                updatePolyline();
                statusDiv.textContent = `Enregistrement: ${trackPoints.length} points. Précision: ${radius.toFixed(0)}m.`;
            } else if (!watchId) { // Si pas d'enregistrement et pas de watch actif
                 statusDiv.textContent = `Localisé. Précision: ${radius.toFixed(0)}m.`;
            }
        }

        function onLocationError(e) {
            loader.style.display = 'none';
            alert("Erreur de géolocalisation: " + e.message);
            statusDiv.textContent = "Erreur de géolocalisation.";
        }

        function updatePolyline() {
            const latLngs = trackPoints.map(p => [p.lat, p.lon]);
            if (!trackPolyline) {
                trackPolyline = L.polyline(latLngs, {color: 'red', weight: 3}).addTo(map);
            } else {
                trackPolyline.setLatLngs(latLngs);
            }
            if (latLngs.length > 1) { // S'assurer qu'il y a au moins 2 points pour un bounds
                map.fitBounds(trackPolyline.getBounds().pad(0.1)); // pad pour un peu de marge
            } else if (latLngs.length === 1) {
                map.panTo(latLngs[0]);
            }
        }

        // --- Contrôles d'enregistrement ---
        startStopBtn.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        function startRecording() {
            if (!navigator.geolocation) {
                alert("La géolocalisation n'est pas supportée par votre navigateur.");
                return;
            }
            isRecording = true;
            trackPoints = [];
            if (trackPolyline) {
                map.removeLayer(trackPolyline);
                trackPolyline = null;
            }
            startStopBtn.textContent = "Arrêter Enregistrement";
            startStopBtn.style.backgroundColor = "#dc3545"; // Rouge pour arrêt
            startStopBtn.style.color = "white";
            downloadGpxBtn.disabled = true;
            downloadKmlBtn.disabled = true;
            statusDiv.textContent = "Démarrage de l'enregistrement...";
            loader.style.display = 'block';

            map.stopLocate(); // Arrête la localisation ponctuelle si active

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    loader.style.display = 'none';
                    const latlng = L.latLng(position.coords.latitude, position.coords.longitude);
                    onLocationFound({
                        latlng: latlng,
                        accuracy: position.coords.accuracy,
                        altitude: position.coords.altitude
                    });
                    // Recentrer la carte sur l'utilisateur seulement si l'utilisateur n'a pas déplacé la carte manuellement
                    if (!map.dragging._enabled && !map._panAnim) { // Heuristique simple
                       map.setView(latlng, Math.max(map.getZoom(), 16));
                    }
                },
                (error) => {
                    onLocationError({ message: `Watch Error (${error.code}): ${error.message}` });
                },
                { enableHighAccuracy: true, timeout: 20000, maximumAge: 1000 } // timeout et maximumAge ajustés
            );
        }

        function stopRecording() {
            isRecording = false;
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            loader.style.display = 'none';
            // map.stopLocate(); // Peut être redondant si clearWatch arrête tout
            startStopBtn.textContent = "Démarrer Enregistrement";
            startStopBtn.style.backgroundColor = ""; // Retour au style par défaut
            startStopBtn.style.color = "";
            statusDiv.textContent = `Enregistrement terminé. ${trackPoints.length} points capturés.`;
            if (trackPoints.length > 0) {
                downloadGpxBtn.disabled = false;
                downloadKmlBtn.disabled = false;
            }
            // Relancer une localisation ponctuelle pour garder le marqueur à jour si souhaité
            // map.locate({setView: false, maxZoom: 16, watch: false, enableHighAccuracy: true});
        }

        // --- Génération et Téléchargement GPX ---
        downloadGpxBtn.addEventListener('click', () => {
            if (trackPoints.length === 0) {
                alert("Aucun point à exporter.");
                return;
            }
            const gpxData = generateGPX();
            downloadFile(gpxData, `trace_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.gpx`, 'application/gpx+xml');
        });

        function generateGPX() {
            const name = "Trace PWA GPS";
            let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Ma PWA GPS"
    xmlns="http://www.topografix.com/GPX/1/1"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">
    <metadata>
        <name>${name}</name>
        <time>${trackPoints.length > 0 ? trackPoints[0].time : new Date().toISOString()}</time>
    </metadata>
    <trk>
        <name>${name}</name>
        <trkseg>`;

            trackPoints.forEach(p => {
                gpx += `
            <trkpt lat="${p.lat.toFixed(6)}" lon="${p.lon.toFixed(6)}">`;
                if (p.ele !== null && !isNaN(p.ele)) {
                    gpx += `<ele>${p.ele.toFixed(2)}</ele>`;
                }
                gpx += `<time>${p.time}</time>
            </trkpt>`;
            });

            gpx += `
        </trkseg>
    </trk>
</gpx>`;
            return gpx;
        }

        // --- Génération et Téléchargement KML ---
        downloadKmlBtn.addEventListener('click', () => {
            if (trackPoints.length === 0) {
                alert("Aucun point à exporter.");
                return;
            }
            const kmlData = generateKML();
            downloadFile(kmlData, `trace_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.kml`, 'application/vnd.google-earth.kml+xml');
        });

        function generateKML() {
            const name = "Trace PWA GPS";
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
        <name>${name}</name>
        <Style id="trackStyle">
            <LineStyle>
                <color>ff0000ff</color> <width>4</width>
            </LineStyle>
            <IconStyle>
                <scale>0</scale> </IconStyle>
        </Style>
        <Placemark>
            <name>${name}</name>
            <styleUrl>#trackStyle</styleUrl>
            <LineString>
                <tessellate>1</tessellate>
                <coordinates>`;

            trackPoints.forEach(p => {
                kml += `${p.lon.toFixed(6)},${p.lat.toFixed(6)},${(p.ele !== null && !isNaN(p.ele)) ? p.ele.toFixed(2) : 0} `;
            });

            kml += `
                </coordinates>
            </LineString>
        </Placemark>
    </Document>
</kml>`;
            return kml;
        }

        // --- Fonction utilitaire de téléchargement ---
        function downloadFile(content, fileName, contentType) {
            const a = document.createElement("a");
            const file = new Blob([content], {type: contentType});
            a.href = URL.createObjectURL(file);
            a.download = fileName;
            document.body.appendChild(a); // Requis pour Firefox
            a.click();
            document.body.removeChild(a); // Nettoyage
            URL.revokeObjectURL(a.href);
        }

        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', () => {
            initMap(osmLayer); // Démarrer avec OSM par défaut
        });
    </script>
</body>
</html>